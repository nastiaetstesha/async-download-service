# Микросервис для скачивания файлов

Микросервис помогает работе основного сайта, сделанного на CMS и обслуживает
запросы на скачивание архивов с файлами. Микросервис не умеет ничего, кроме упаковки файлов
в архив. Закачиваются файлы на сервер через FTP или админку CMS.

Создание архива происходит на лету по запросу от пользователя. Архив не сохраняется на диске, вместо этого по мере упаковки он сразу отправляется пользователю на скачивание.

От неавторизованного доступа архив защищен хешом в адресе ссылки на скачивание, например: `http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/`. Хеш задается названием каталога с файлами, выглядит структура каталога так:

```
- photos
    - 3bea29ccabbbf64bdebcc055319c5745
      - 1.jpg
      - 2.jpg
      - 3.jpg
    - af1ad8c76fda2e48ea9aed2937e972ea
      - 1.jpg
      - 2.jpg
```


## Как установить

Для работы микросервиса нужен Python версии не ниже 3.6.

```bash
pip install -r requirements.txt
```

## Как запустить

```bash
python server.py
```

Сервер запустится на порту 8080, чтобы проверить его работу перейдите в браузере на страницу [http://127.0.0.1:8080/](http://127.0.0.1:8080/).

## Как развернуть на сервере

```bash
python server.py
```

После этого перенаправить на микросервис запросы, начинающиеся с `/archive/`. Например:

```
GET http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/
GET http://host.ru/archive/af1ad8c76fda2e48ea9aed2937e972ea/
```
Как менять настройки (без правки кода)

На macOS/zsh:

### 1) Выключить логирование
`LOG=0 python server.py`

### 2) Включить логирование уровня DEBUG
`LOG=1 LOG_LEVEL=DEBUG python server.py`

### 3) Включить «задержку» (ограничение скорости 80 кибит/с)
`THROTTLE_KBPS=80 python server.py`

### 4) Указать путь к каталогу с фотографиями
`PHOTOS_DIR="/полный/путь/к/photos" python server.py`


Дополнительно: для одного запроса можно временно перекрыть скорость параметром URL:

`http://127.0.0.1:8080/archive/7kna/?kbps=30`
# Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).

## Переменные окружения

- `PHOTOS_DIR (string, путь)` - абсолютный путь /abs/path/... или относительный (от папки server.py), например ../test_photos

- `LOG (bool)` - включает/выключает наше логирование (и access-лог aiohttp).
Допустимые значения: 1, true, yes, on → вкл; 0, false, no, off → выкл (регистр не важен).
По умолчанию: 1 (включено)

- `LOG_LEVEL (string)` - уровень логов, используется только если LOG=1.
Допустимые значения: DEBUG, INFO, WARNING, ERROR, CRITICAL.
По умолчанию: INFO

- `THROTTLE_KBPS (float ≥ 0)` - «задержка ответа» — ограничивает скорость отдачи архива.
Единицы: кибит/сек (Kib/s). Пример: 80 ≈ 10 KiB/s.
По умолчанию: 0 (без ограничения)


